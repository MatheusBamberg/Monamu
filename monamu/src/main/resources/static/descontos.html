<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descontos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
</head>

<body class="bg-light p-4">

    <main class="container bg-white p-4 rounded-4 shadow-sm">
        <!-- Cabeçalho -->
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="m-0">Descontos</h1>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#modalDesconto"
                onclick="abrirModalNovoDesconto()">
                <i class="bi bi-plus"></i>
                Cadastrar Desconto
            </button>
        </header>

        <!-- Tabela -->
        <section>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Valor do desconto (%)</th>
                        <th>Data de início</th>
                        <th>Data de validade</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="text-center">
                            <button class="action edit"><i class="bi bi-pencil"></i></button>
                            <button class="action delete"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <!-- Modal de cadastro -->
    <div class="modal fade" id="modalDesconto" tabindex="-1" aria-labelledby="modalDescontoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <form id="formDesconto">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalDescontoLabel">Novo Desconto</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nomeDesconto" class="form-label">Nome</label>
                                <input type="text" id="nomeDesconto" class="form-control" required>
                            </div>

                            <div class="col-md-6">
                                <label for="valorDesconto" class="form-label">Valor do Desconto (%)</label>
                                <input type="number" id="valorDesconto" class="form-control" required>
                            </div>

                            <div class="col-md-6">
                                <label for="dataInicio" class="form-label">Data de início</label>
                                <input type="date" id="dataInicio" class="form-control" required>
                            </div>

                            <div class="col-md-6">
                                <label for="dataValidade" class="form-label">Data de validade</label>
                                <input type="date" id="dataValidade" class="form-control" required>
                            </div>

                        </div>
                    </div>
                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiDescontos = "/api/descontos";

        const modalDescontoEl = document.getElementById("modalDesconto");
        const modalDesconto = new bootstrap.Modal(modalDescontoEl);

        function carregarDescontos() {
            axios.get(apiDescontos)
                .then(res => {
                    const tbody = document.querySelector("table tbody");
                    tbody.innerHTML = "";

                    res.data.forEach(d => {
                        tbody.innerHTML += `
                        <tr>
                            <td>${d.nome}</td>
                            <td>${d.valor}%</td>
                            <td>${d.dataCadastro ? d.dataCadastro.substring(0, 10) : ""}</td>
                            <td>${d.dataValidade}</td>
                            <td class="text-center">
                                <button class="action edit" onclick="editarDesconto(${d.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action delete" onclick="excluirDesconto(${d.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    });
                })
                .catch(err => console.error("Erro ao carregar descontos:", err));
        }

        carregarDescontos();

        function abrirModalNovoDesconto() {
            document.getElementById("formDesconto").reset();
            document.getElementById("descontoId")?.remove();
            document.getElementById("modalDescontoLabel").textContent = "Novo Desconto";

            const hoje = new Date().toISOString().substring(0, 10);
            document.getElementById("dataInicio").value = hoje;

            modalDesconto.show();
        }

        // Salvar / Atualizar desconto
        document.getElementById("formDesconto").addEventListener("submit", (e) => {
            e.preventDefault();

            const id = document.getElementById("descontoId")?.value;

            const desconto = {
                nome: document.getElementById("nomeDesconto").value,
                valor: parseFloat(document.getElementById("valorDesconto").value),
                dataCadastro: document.getElementById("dataInicio").value + "T00:00:00",
                dataValidade: document.getElementById("dataValidade").value
            };

            const metodo = id ? "put" : "post";
            const url = id ? `${apiDescontos}/${id}` : apiDescontos;

            axios[metodo](url, desconto)
                .then(() => {
                    carregarDescontos();
                    modalDesconto.hide();
                })
                .catch(err => {
                    console.error(err);
                    alert(err.response?.data?.erro || "Erro ao salvar desconto");
                });
        });

        function editarDesconto(id) {
            axios.get(`${apiDescontos}/${id}`)
                .then(res => {
                    const d = res.data;

                    document.getElementById("descontoId")?.remove();
                    const inputId = document.createElement("input");
                    inputId.type = "hidden";
                    inputId.id = "descontoId";
                    inputId.value = d.id;
                    document.getElementById("formDesconto").appendChild(inputId);

                    document.getElementById("nomeDesconto").value = d.nome;
                    document.getElementById("valorDesconto").value = d.valor;
                    document.getElementById("dataInicio").value = d.dataCadastro.substring(0, 10);
                    document.getElementById("dataValidade").value = d.dataValidade;

                    document.getElementById("modalDescontoLabel").textContent = "Editar Desconto";

                    modalDesconto.show();
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao buscar desconto");
                });
        }

        function excluirDesconto(id) {
            if (!confirm("Deseja realmente excluir este desconto?")) return;

            axios.delete(`${apiDescontos}/${id}`)
                .then(() => carregarDescontos())
                .catch(err => {
                    console.error(err);
                    alert("Erro ao excluir desconto");
                });
        }
    </script>

</body>

</html>