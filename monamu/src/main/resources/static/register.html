<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Funcionário e Usuário</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h2>Cadastro de Funcionário e Usuário</h2>
    <div id="error" class="alert alert-danger" style="display:none;"></div>
    <div id="success" class="alert alert-success" style="display:none;"></div>

    <form id="formCadastro">
        <h4>Informações do Funcionário</h4>
        <div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="nomeFuncionario" required></div>
        <div class="mb-3"><label>CPF</label><input type="text" class="form-control" id="cpfFuncionario" required></div>
        <div class="mb-3"><label>Cargo</label><input type="text" class="form-control" id="cargoFuncionario" required></div>
        <div class="mb-3"><label>Telefone</label><input type="text" class="form-control" id="telefoneFuncionario" required></div>
        <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="emailFuncionario" required></div>
        <div class="mb-3">
            <label>Sexo</label>
            <select class="form-control" id="sexoFuncionario" required>
                <option value="" selected disabled>Selecione...</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
            </select>
        </div>
        <div class="mb-3"><label>Data de Admissão</label><input type="date" class="form-control" id="dataAdmissao" required></div>
        <div class="mb-3"><label>Rua</label><input type="text" class="form-control" id="ruaFuncionario" required></div>
        <div class="mb-3"><label>Bairro</label><input type="text" class="form-control" id="bairroFuncionario" required></div>
        <div class="mb-3"><label>Cidade</label><input type="text" class="form-control" id="cidadeFuncionario" required></div>
        <div class="mb-3"><label>Estado</label><input type="text" class="form-control" id="estadoFuncionario" required></div>

        <h4>Informações do Usuário</h4>
        <div class="mb-3"><label>Usuário</label><input type="text" class="form-control" id="username" required></div>
        <div class="mb-3"><label>Senha</label><input type="password" class="form-control" id="senha" required></div>

        <button type="submit" class="btn btn-primary" id="btnCreate">Criar Funcionário e Usuário</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

document.getElementById("formCadastro").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nomeFuncionario").value.trim();
    const cpf = document.getElementById("cpfFuncionario").value.trim();
    const cargo = document.getElementById("cargoFuncionario").value.trim();
    const telefone = document.getElementById("telefoneFuncionario").value.trim();
    const email = document.getElementById("emailFuncionario").value.trim();
    const sexo = document.getElementById("sexoFuncionario").value.trim();
    const dataAdmissao = document.getElementById("dataAdmissao").value;
    const rua = document.getElementById("ruaFuncionario").value.trim();
    const bairro = document.getElementById("bairroFuncionario").value.trim();
    const cidade = document.getElementById("cidadeFuncionario").value.trim();
    const estado = document.getElementById("estadoFuncionario").value.trim();

    const username = document.getElementById("username").value.trim();
    const senha = document.getElementById("senha").value.trim();

    const errEl = document.getElementById("error");
    const okEl = document.getElementById("success");
    errEl.style.display = 'none';
    okEl.style.display = 'none';

    if (!nome || !cpf || !cargo || !telefone || !email || !sexo || !dataAdmissao || !rua || !bairro || !cidade || !estado || !username || !senha) {
        errEl.textContent = "Preencha todos os campos.";
        errEl.style.display = "block";
        return;
    }

    if (senha.length < 6) {
        errEl.textContent = "Senha deve ter ao menos 6 caracteres.";
        errEl.style.display = "block";
        return;
    }

    try {
        // 1️⃣ Criar Funcionário
        const resFunc = await axios.post("/api/funcionarios", {
            nome, cpf, cargo, telefone, email, sexo,
            dataAdmissao: dataAdmissao + "T00:00:00",
            rua, bairro, cidade, estado
        });

        const funcionario = resFunc.data;

        // O correto é usar funcionario.codpes
        const codpes = (funcionario.pessoa && funcionario.pessoa.codpes) || funcionario.id;

        if (!codpes) throw new Error("Não foi possível recuperar 'codpes' do funcionário!");

        // 2️⃣ Criar Usuário com x-www-form-urlencoded
        const formData = new URLSearchParams();
        formData.append("username", username);
        formData.append("senha", senha);
        formData.append("codpes", codpes);

        await axios.post("/api/auth/criar", formData, {
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });

        okEl.textContent = "Funcionário e Usuário criados com sucesso! Redirecionando...";
        okEl.style.display = "block";

        // 3️⃣ Redirecionar para a tela de login após 1.5 segundos
        setTimeout(() => {
            window.location.href = "/login.html"; 
        }, 1500);

    } catch (err) {
        const msg = err.response?.data?.erro || err.response?.data?.message || err.message || "Erro ao criar funcionário/usuário";
        errEl.textContent = msg;
        errEl.style.display = "block";
    }
});
</script>
</body>
</html>