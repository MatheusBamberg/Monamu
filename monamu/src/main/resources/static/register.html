<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/login.css">
</head>

<body>

    <div class="d-flex justify-content-center align-items-center vh-100">
        <div class="card card-custom p-4">
            <img src="imagens/logo.png" alt="Logo do sistema escrita Monamu" class="mx-auto d-block mb-3 logo">

            <div id="error" class="alert alert-danger hidden"></div>
            <div id="success" class="alert alert-success hidden"></div>

            <form id="formCadastro">

                <h5>Informações do Funcionário</h5>
                <div class="mb-2"><input type="text" class="form-control" id="nomeFuncionario" placeholder="Nome"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="cpfFuncionario" placeholder="CPF"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="cargoFuncionario" placeholder="Cargo"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="telefoneFuncionario"
                        placeholder="Telefone" required></div>
                <div class="mb-2"><input type="email" class="form-control" id="emailFuncionario" placeholder="Email"
                        required></div>
                <div class="mb-2">
                    <select class="form-control" id="sexoFuncionario" required>
                        <option value="" selected disabled>Sexo</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                    </select>
                </div>
                <div class="mb-2"><input type="date" class="form-control" id="dataAdmissao" required></div>
                <div class="mb-2"><input type="text" class="form-control" id="ruaFuncionario" placeholder="Rua"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="bairroFuncionario" placeholder="Bairro"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="cidadeFuncionario" placeholder="Cidade"
                        required></div>
                <div class="mb-2"><input type="text" class="form-control" id="estadoFuncionario" placeholder="Estado"
                        required></div>

                <h5 class="mt-3">Informações do Usuário</h5>
                <div class="mb-2"><input type="text" class="form-control" id="username" placeholder="Usuário" required>
                </div>
                <div class="mb-3"><input type="password" class="form-control" id="senha" placeholder="Senha" required>
                </div>

                <button type="submit" class="btn w-100" id="btnCreate">Criar Funcionário e Usuário</button>

                <p class="text-center mt-3" id="voltar">
                    <a href="login.html" class="link text-primary">Voltar ao login</a>
                </p>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.getElementById("formCadastro").addEventListener("submit", async (e) => {
            e.preventDefault();

            const nome = document.getElementById("nomeFuncionario").value.trim();
            const cpf = document.getElementById("cpfFuncionario").value.trim();
            const cargo = document.getElementById("cargoFuncionario").value.trim();
            const telefone = document.getElementById("telefoneFuncionario").value.trim();
            const email = document.getElementById("emailFuncionario").value.trim();
            const sexo = document.getElementById("sexoFuncionario").value.trim();
            const dataAdmissao = document.getElementById("dataAdmissao").value;
            const rua = document.getElementById("ruaFuncionario").value.trim();
            const bairro = document.getElementById("bairroFuncionario").value.trim();
            const cidade = document.getElementById("cidadeFuncionario").value.trim();
            const estado = document.getElementById("estadoFuncionario").value.trim();

            const username = document.getElementById("username").value.trim();
            const senha = document.getElementById("senha").value.trim();

            const errEl = document.getElementById("error");
            const okEl = document.getElementById("success");
            errEl.classList.add('hidden');
            okEl.classList.add('hidden');

            if (!nome || !cpf || !cargo || !telefone || !email || !sexo || !dataAdmissao || !rua || !bairro || !cidade || !estado || !username || !senha) {
                errEl.textContent = "Preencha todos os campos.";
                errEl.classList.remove("hidden");
                return;
            }

            if (senha.length < 6) {
                errEl.textContent = "Senha deve ter ao menos 6 caracteres.";
                errEl.classList.remove("hidden");
                return;
            }

            try {
                const resFunc = await axios.post("/api/funcionarios", {
                    nome, cpf, cargo, telefone, email, sexo,
                    dataAdmissao: dataAdmissao + "T00:00:00",
                    rua, bairro, cidade, estado
                });
                const funcionario = resFunc.data;
                const codpes = (funcionario.pessoa && funcionario.pessoa.codpes) || funcionario.id;
                if (!codpes) throw new Error("Não foi possível recuperar 'codpes' do funcionário!");

                const formData = new URLSearchParams();
                formData.append("username", username);
                formData.append("senha", senha);
                formData.append("codpes", codpes);

                await axios.post("/api/auth/criar", formData, {
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                });

                okEl.textContent = "Funcionário e Usuário criados com sucesso! Redirecionando...";
                okEl.classList.remove('hidden');

                setTimeout(() => {
                    window.location.href = "/login.html";
                }, 1500);

            } catch (err) {
                const msg = err.response?.data?.erro || err.response?.data?.message || err.message || "Erro ao criar funcionário/usuário";
                errEl.textContent = msg;
                errEl.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>
<style>
    body {
        margin: 180px;
    }

    p,
    a,
    #voltar {
        color: #6f42c1;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
    }

    a:hover {
        color: #a084e0;
        text-decoration: none;
    }

    .btn {
        background-color: #6744cf;
        color: white;
    }

    .btn:hover {
        background: #a084f3;
        color: white;
    }



    @media (max-width: 768px) {
        .card-custom {
            max-width: 95%;
            padding: 1.5rem;
        }
    }

    img.logo {
        max-width: 190px;
    }

    .error,
    .success {
        text-align: center;
        padding: 10px;
        border-radius: 8px;
    }

    .error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .success {
        background-color: #d4edda;
        color: #155724;
    }
</style>